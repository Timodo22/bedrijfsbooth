function P(t){return O(t).map(e=>e instanceof Error?e:new p(`[${typeof e}] ${$(e).slice(0,10240)}`))}function O(t,e=0){return e>=20?[t,"Truncated cause stack"]:t instanceof Error&&t.cause?[t,...O(t.cause,e+1)]:[t]}function $(t){if(typeof t!="string")try{return JSON.stringify(t)??typeof t}catch{}return`${t}`}var p=class extends Error{name="BugsnagInvalidError"};var N=/^\s*at .*(\S+:\d+|\(native\))/m,j=/^(eval@)?(\[native code])?$/;function E(t){return t.stack?t.stack.match(N)?U(t):q(t):[]}function w(t){if(t.indexOf(":")===-1)return[t];let n=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(t.replace(/[()]/g,""));return[n[1],n[2]?Number(n[2]):void 0,n[3]?Number(n[3]):void 0]}function U(t){return t.stack.split(`
`).filter(n=>!!n.match(N)).map(n=>{let r=n.replace(/^\s+/,"").replace(/^.*?\s+/,""),s=r.match(/ (\(.+\)$)/);r=s?r.replace(s[0],""):r;let a=w(s?s[1]:r),o=s&&r||void 0,i=["eval","<anonymous>"].indexOf(a[0])>-1?void 0:a[0];return{method:o,file:i,lineNumber:a[1],columnNumber:a[2]}})}function q(t){return t.stack.split(`
`).filter(n=>!n.match(j)).map(n=>{if(n.indexOf("@")===-1&&n.indexOf(":")===-1)return{method:n};let r=/((.*".+"[^@]*)?[^@]*)(?:@)/,s=n.match(r),a=s&&s[1]?s[1]:void 0,o=w(n.replace(r,""));return{method:a,file:o[0],lineNumber:o[1],columnNumber:o[2]}})}var v="5",x=class{breadcrumbs=[];apiKey;plugins;appId;appType;appVersion;releaseStage;locale;userAgent;metadata;persistedMetadata;onError;onPostErrorListeners=[];endpoints;session;constructor(e){this.apiKey=e.apiKey,this.appType=e.appType,this.appId=e.appId,this.appVersion=e.appVersion,this.releaseStage=e.releaseStage,this.locale=e.locale,this.userAgent=e.userAgent,this.metadata=e.metadata,this.onError=e.onError,this.persistedMetadata={},this.endpoints=e.endpoints??{notify:"https://error-analytics-production.shopifysvc.com",sessions:"https://error-analytics-sessions-production.shopifysvc.com/observeonly"},this.plugins=e.plugins??[],this.plugins.forEach(n=>n.load(this)),this.leaveBreadcrumb("Bugsnag started",void 0,"state"),(e.withSessionTracking??!0)&&(this.session={id:this.getRandomUUID(),startedAt:new Date().toISOString(),events:{handled:0,unhandled:0}},this.startSession())}addMetadata(e){for(let n of Object.keys(e))this.persistedMetadata[n]=e[n]}getSessionId(){return this.session?.id}leaveBreadcrumb(e,n,r="manual"){this.breadcrumbs.push({name:e,metaData:n,type:r,timestamp:new Date().toISOString()})}notify(e,{errorClass:n,severity:r,severityType:s,handled:a=!0,metadata:o,context:i,groupingHash:d}={}){let c=P(e),f={...this.metadata,...this.persistedMetadata,...o},l=this.buildBugsnagEvent(c,{errorClass:n,severityType:s,handled:a,severity:r,metadata:f,context:i,groupingHash:d});if((this.onError?.(l,e)??!0)&&this.releaseStage!=="development"){this.updateAndAppendSessionInformation(l);let y=this.sendToBugsnag(l);return this.onPostErrorListeners.forEach(b=>b(l)),y}return Promise.resolve()}addOnPostError(e){this.onPostErrorListeners.push(e)}updateAndAppendSessionInformation(e){this.session&&(e.unhandled?this.session.events.unhandled++:this.session.events.handled++,e.session=this.session)}buildBugsnagEvent(e,{errorClass:n,severity:r="error",severityType:s="handledException",handled:a,metadata:o={},context:i,groupingHash:d}){let c=new Date().toISOString(),{breadcrumbs:u,appId:f,appType:l,appVersion:S,releaseStage:y,locale:b,userAgent:A}=this,I=e.map((m,T)=>({errorClass:T===0?n??m.name:m.name,stacktrace:R(f,m),message:m.message,type:"browserjs"}));return{payloadVersion:v,exceptions:I,severity:r,severityReason:{type:s},unhandled:!a,app:{id:f,type:l,version:S,releaseStage:y},device:{time:c,locale:b,userAgent:A},breadcrumbs:u,context:i,metaData:o,groupingHash:d}}async startSession(){if(this.releaseStage==="development"){console.log("Skipping error logging session tracking in development mode");return}let{apiKey:e}=this,n={notifier:{name:"Bugsnag JavaScript",version:"7.22.2",url:"https://github.com/bugsnag/bugsnag-js"},app:{version:this.appVersion,releaseStage:this.releaseStage,type:this.appType},device:{id:this.appId,locale:this.locale,userAgent:this.userAgent},sessions:[this.session]};try{await fetch(this.endpoints.sessions,{method:"POST",headers:{"Content-Type":"application/json","Bugsnag-Api-Key":e,"Bugsnag-Payload-Version":v,"Bugsnag-Sent-At":this.session?.startedAt??new Date().toISOString()},body:JSON.stringify(n)})}catch(r){console.warn("[bugsnag-light] failed to start session"),console.warn(r)}}async sendToBugsnag(e){let{apiKey:n}=this,r={apiKey:n,notifier:{name:"Bugsnag JavaScript",version:"7.22.2",url:"https://github.com/bugsnag/bugsnag-js"},events:[e]};try{await fetch(this.endpoints.notify,{method:"POST",headers:{"Content-Type":"application/json","Bugsnag-Api-Key":n,"Bugsnag-Payload-Version":v,"Bugsnag-Sent-At":e.device.time},body:JSON.stringify(r)})}catch(s){console.warn("[bugsnag-light] failed to send an event"),console.warn(s)}}getRandomUUID(){try{return crypto.randomUUID()}catch{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let n=Math.random()*16|0;return(e==="x"?n:n&3|8).toString(16)})}}};function R(t,e){let r=E(e).map(s=>{let a=s.file?.includes(t);return{method:s.method??"",file:s.file??"",lineNumber:s.lineNumber??0,columnNumber:s.columnNumber,inProject:a}});if(e instanceof p){let s=r.findIndex(a=>a.method.endsWith("notify"));s>-1&&(r=r.slice(s+1))}return r}var g=class t extends Error{reason;constructor(e){super(e),this.name="BreadcrumbsPluginFetchError",Object.setPrototypeOf(this,t.prototype)}};function D(t,{metadata:e}={}){let n=window.onerror;window.onerror=(r,s,a,o,i)=>{i&&t.notify(i,{severityType:"unhandledException",handled:!1,metadata:e}),typeof n=="function"&&n.apply(window.onerror,[r,s,a,o,i])}}function H(t,{metadata:e}={}){window.addEventListener("unhandledrejection",n=>{n.reason&&!(n.reason instanceof g)&&t.notify(n.reason,{severityType:"unhandledPromiseRejection",handled:!1,metadata:e})})}var F={load(t){t.addOnPostError(e=>{t.leaveBreadcrumb(e.exceptions[0].errorClass,{errorClass:e.exceptions[0].errorClass,errorMessage:e.exceptions[0].message,severity:e.severity},"error")})}};function h(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}var V={load(t){"addEventListener"in self&&self.addEventListener("click",e=>{let n="[hidden]";try{let r=K(e.target)?e.target:null;n=r?C(r):"(Non-Element Target)"}catch{}t.leaveBreadcrumb("UI click",{targetSelector:n},"user")},!0)}};function K(t){return h(t)&&t.nodeType===Node.ELEMENT_NODE}function C(t){let e=t.tagName;if(t.id&&(e+=`#${t.id}`),t.className?.length&&(e+=`.${t.className.replace(/ /g,".")}`),!self.document.querySelectorAll)return e;try{if(self.document.querySelectorAll(e).length===1)return e}catch{return e}if(t.parentNode&&t.parentNode.childNodes.length>1){let n=Array.from(t.parentNode.children).indexOf(t)+1;e+=`:nth-child(${n})`}return self.document.querySelectorAll(e).length===1?e:t.parentElement?`${C(t.parentElement)} > ${e}`:e}var _={load(t){let e=["log","debug","info","warn","error"].filter(n=>typeof console<"u"&&typeof console[n]=="function");for(let n of e){let r=console[n];console[n]=(...s)=>{t.leaveBreadcrumb("Console output",s.reduce((a,o,i)=>{let d="[Unknown value]";try{d=String(o)}catch{}if(d==="[object Object]")try{d=JSON.stringify(o)}catch{}return a[`[${i}]`]=d,a},{severity:n}),"log"),r.apply(console,s)}}}};var W={load(t){if(!("addEventListener"in self))return;let e=r=>()=>t.leaveBreadcrumb(r,void 0,"navigation");self.addEventListener("pagehide",e("Page hidden"),!0),self.addEventListener("pageshow",e("Page shown"),!0),self.addEventListener("load",()=>{e("Page loaded"),self.addEventListener("popstate",e("Navigated back"),!0)},!0),self.document?.addEventListener("DOMContentLoaded",e("DOMContentLoaded"),!0),self.location&&self.addEventListener("hashchange",r=>t.leaveBreadcrumb("Hash changed",{from:r.oldURL&&B(r.oldURL),to:B(r.oldURL?r.newURL:self.location.href),state:r.oldURL&&L(self)},"navigation"),!0);let n=t.leaveBreadcrumb.bind(t);self.history&&self instanceof Window&&(typeof self.history.replaceState=="function"&&k({fn:"replaceState",target:self.history,leaveBreadcrumb:n,win:self}),typeof self.history.pushState=="function"&&k({fn:"pushState",target:self.history,leaveBreadcrumb:n,win:self}))}};function B(t){try{let e=new URL(t);return`${e.pathname}${e.search}${e.hash}`}catch{return t}}function L(t){try{return t.history.state}catch{return{}}}function k({fn:t,leaveBreadcrumb:e,target:n,win:r}){let s=n[t];n[t]=(a,o,i)=>{e(`History ${t}`,J({win:r,state:a,title:o,url:i}),"navigation"),s.apply(n,[a,o,i])}}function J({win:t,state:e,title:n,url:r}){let s=B(t.location.href);return{title:n,state:e,prevState:L(t),to:r||s,from:s}}var G={load(t){if(!("fetch"in self))return;let e=self.fetch;self.fetch=function(r,s){let a="GET",o;X(r)?(o=r.url,a=r.method):o=r.toString(),s&&typeof s.method=="string"&&s.method.length&&(a=s.method);let i=t.leaveBreadcrumb.bind(t);return new Promise((d,c)=>{e(r,s).then(u=>{M({message:`fetch() ${u.status>=400?"failed":"succeeded"}`,url:o,leaveBreadcrumb:i,breadcrumbMetadata:{request:`${a} ${o}`,status:u.status}}),d(u)}).catch(u=>{M({message:"fetch() error",url:o,leaveBreadcrumb:i,breadcrumbMetadata:{error:u?.message,request:`${a} ${o}`}}),c(new g(u?.message))})})}}};function X(t){return t instanceof Request||h(t)&&"url"in t}function M({message:t,url:e,leaveBreadcrumb:n,breadcrumbMetadata:r}){e.startsWith("https://notify.bugsnag")||n(t,r,"request")}export{x as BugsnagLight,F as ErrorBreadcrumbsPlugin,V as InteractionBreadcrumbsPlugin,_ as LogBreadcrumbsPlugin,W as NavigationBreadcrumbsPlugin,G as RequestBreadcrumbsPlugin,R as formatStackTrace,E as parseErrorStack,D as registerOnErrorHandler,H as registerUnhandledPromiseRejectionHandler};
//# sourceMappingURL=index.mjs.map